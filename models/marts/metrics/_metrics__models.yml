version: 2

models:
  - name: metrics_exposure_timeseries
    description: |
      **[NEW - Unified Model]** BI-ready time-series metrics model showing cumulative exposure 
      across all dimensions (fund, region, country, industry, stage) over time. This unified model 
      replaces metrics_exposure_by_region and metrics_exposure_by_industry, eliminating duplication 
      and providing a single source of truth for exposure analytics.
      
      **Grain**: One row per month per fund per region per country per industry per stage
      
      **Source Systems**: Portfolio Management (PM), CRM
      
      **Key Features**:
      - No pre-aggregated 'ALL' values - filtering and aggregation happens in BI layer
      - All dimensions in one table for flexible slicing and dicing
      - Consistent business logic across all dimensional views
      - Supports both deployed capital (current) and pipeline forecasts
      
      **Use Cases**:
      - Regional/country exposure forecasting
      - Industry concentration analysis
      - Multi-dimensional exposure breakdowns
      - Pipeline stage analysis across any dimension
      - Custom aggregations and drill-downs
      
      **Example Queries**:
      ```sql
      -- Regional exposure for a specific fund
      SELECT 
        exposure_month,
        region,
        SUM(total_exposure_usd) as total_exposure
      FROM metrics_exposure_timeseries
      WHERE fund_id = 'FUND123'
        AND stage_id = 'STG001'
      GROUP BY exposure_month, region
      ORDER BY exposure_month;
      
      -- Industry breakdown across all funds
      SELECT 
        industry_name,
        SUM(deployed_capital_usd) as deployed_capital
      FROM metrics_exposure_timeseries
      WHERE period_type = 'Current'
        AND exposure_month = DATE_TRUNC('month', CURRENT_DATE)
      GROUP BY industry_name
      ORDER BY deployed_capital DESC;
      
      -- Multi-dimensional drill-down
      SELECT 
        region,
        country_name,
        industry_name,
        SUM(total_exposure_usd) as exposure
      FROM metrics_exposure_timeseries
      WHERE fund_id = 'FUND123'
        AND exposure_month = DATE_TRUNC('month', CURRENT_DATE)
      GROUP BY region, country_name, industry_name;
      ```
    columns:
      - name: exposure_month
        description: "First day of the month for the exposure data"
        tests:
          - not_null
      
      - name: exposure_year
        description: "Year extracted from exposure_month"
        tests:
          - not_null
      
      - name: exposure_month_num
        description: "Month number (1-12) extracted from exposure_month"
        tests:
          - not_null
      
      - name: fund_id
        description: "Fund identifier"
        tests:
          - not_null
      
      - name: fund_name
        description: "Fund name"
        tests:
          - not_null
      
      - name: region
        description: "Geographic region (e.g., North America, Europe, Asia Pacific, Unknown Region)"
        tests:
          - not_null
      
      - name: country_code
        description: "ISO2 country code or 'UNKNOWN'"
        tests:
          - not_null
      
      - name: country_name
        description: "Country name or 'Unknown Country'"
        tests:
          - not_null
      
      - name: industry_id
        description: "Industry identifier or 'UNKNOWN'"
        tests:
          - not_null
      
      - name: industry_name
        description: "Industry name or 'Unknown Industry'"
        tests:
          - not_null
      
      - name: stage_id
        description: "Pipeline stage identifier or NULL for deployed capital rows"
      
      - name: stage_name
        description: "Pipeline stage name or NULL for deployed capital rows"
      
      - name: deployed_capital_usd
        description: "Current deployed capital from instrument positions, converted to USD (allocated by country and industry)"
        tests:
          - not_null
      
      - name: closed_pipeline_usd
        description: "Cumulative sum of opportunities that have closed up to and including this month, converted to USD"
        tests:
          - not_null
      
      - name: total_exposure_usd
        description: "Sum of deployed capital and cumulative closed pipeline (shows total exposure growing over time)"
        tests:
          - not_null
      
      - name: period_type
        description: "Indicates if the month is 'Current', 'Historical', or 'Forecast'"
        tests:
          - not_null
          - accepted_values:
              values: ['Current', 'Historical', 'Forecast']
      
      - name: as_of_date
        description: "Date of the latest snapshot used for deployed capital calculations"

  - name: metrics_exposure_by_region
    description: |
      **[DEPRECATED - Use metrics_exposure_timeseries instead]**
      
      This model is deprecated and will be removed in a future release. Please migrate to 
      metrics_exposure_timeseries which provides the same data without pre-aggregated 'ALL' values.
    description: |
      BI-ready time-series metrics model showing cumulative growing exposure by region over time,
      with breakdowns by fund and pipeline stage. Displays deployed capital (baseline) plus 
      cumulative closed opportunities. Includes "All Funds" and "All Stages" aggregations for 
      flexible filtering in BI tools.
      
      **Grain**: One row per region per month per fund per stage
      
      **Source Systems**: Portfolio Management (PM), CRM
      
      **Use Cases**:
      - Regional exposure growth forecast line charts filtered by fund
      - Pipeline stage analysis by region
      - Fund-specific exposure tracking
      - Cross-fund and cross-stage comparisons
      
      **Example Query**:
      ```sql
      -- All funds, all stages for a region
      SELECT 
        exposure_month,
        region,
        total_exposure_usd
      FROM metrics_exposure_by_region
      WHERE region = 'Europe'
        AND fund_id = 'ALL'
        AND stage_id = 'ALL'
      ORDER BY exposure_month;
      
      -- Specific fund, all stages
      SELECT 
        exposure_month,
        region,
        fund_name,
        total_exposure_usd
      FROM metrics_exposure_by_region
      WHERE fund_id = 'FUND123'
        AND stage_id = 'ALL'
      ORDER BY exposure_month;
      ```
    columns:
      - name: exposure_month
        description: "First day of the month for the exposure data"
        tests:
          - not_null
      
      - name: exposure_year
        description: "Year extracted from exposure_month"
        tests:
          - not_null
      
      - name: exposure_month_num
        description: "Month number (1-12) extracted from exposure_month"
        tests:
          - not_null
      
      - name: region
        description: "Geographic region (e.g., North America, Europe, Asia Pacific)"
        tests:
          - not_null
      
      - name: fund_id
        description: "Fund identifier or 'ALL' for aggregated view across all funds"
        tests:
          - not_null
      
      - name: fund_name
        description: "Fund name or 'All Funds' for aggregated view"
        tests:
          - not_null
      
      - name: stage_id
        description: "Pipeline stage identifier or 'ALL' for aggregated view across all stages"
        tests:
          - not_null
      
      - name: stage_name
        description: "Pipeline stage name or 'All Stages' for aggregated view"
        tests:
          - not_null
      
      - name: deployed_capital_usd
        description: "Current deployed capital from instrument positions for this fund, converted to USD"
        tests:
          - not_null
      
      - name: closed_pipeline_usd
        description: "Cumulative sum of opportunities (for this fund and stage) that have closed up to and including this month, converted to USD"
        tests:
          - not_null
      
      - name: total_exposure_usd
        description: "Sum of deployed capital and cumulative closed pipeline (shows total exposure growing over time)"
        tests:
          - not_null
      
      - name: period_type
        description: "Indicates if the month is 'Current', 'Historical', or 'Forecast'"
        tests:
          - not_null
          - accepted_values:
              values: ['Current', 'Historical', 'Forecast']
      
      - name: as_of_date
        description: "Date of the latest snapshot used for deployed capital calculations"

  - name: metrics_exposure_by_industry
    description: |
      **[DEPRECATED - Use metrics_exposure_timeseries instead]**
      
      This model is deprecated and will be removed in a future release. Please migrate to 
      metrics_exposure_timeseries which provides the same data without pre-aggregated 'ALL' values.
      
      **Grain**: One row per industry per month per fund per stage
      
      **Source Systems**: Portfolio Management (PM), CRM
      
      **Use Cases**:
      - Industry exposure growth forecasting by fund
      - Pipeline stage analysis by industry
      - Sector concentration monitoring across funds
      - Cross-fund comparisons within a single industry
      
      **Example Query**:
      ```sql
      -- All funds, all stages for an industry
      SELECT 
        exposure_month,
        industry_name,
        total_exposure_usd
      FROM metrics_exposure_by_industry
      WHERE industry_name = 'Software'
        AND fund_id = 'ALL'
        AND stage_id = 'ALL'
      ORDER BY exposure_month;
      ```
    columns:
      - name: exposure_month
        description: "First day of the month for the exposure data"
        tests:
          - not_null
      
      - name: exposure_year
        description: "Year extracted from exposure_month"
        tests:
          - not_null
      
      - name: exposure_month_num
        description: "Month number (1-12) extracted from exposure_month"
        tests:
          - not_null
      
      - name: industry_id
        description: "Industry identifier or 'UNKNOWN'/'ALL' for aggregated views"
        tests:
          - not_null
      
      - name: industry_name
        description: "Industry name or 'All Industries' for aggregated view"
        tests:
          - not_null
      
      - name: fund_id
        description: "Fund identifier or 'ALL' for aggregated view across all funds"
        tests:
          - not_null
      
      - name: fund_name
        description: "Fund name or 'All Funds' for aggregated view"
        tests:
          - not_null
      
      - name: stage_id
        description: "Pipeline stage identifier or 'ALL' for aggregated view across all stages"
        tests:
          - not_null
      
      - name: stage_name
        description: "Pipeline stage name or 'All Stages' for aggregated view"
        tests:
          - not_null
      
      - name: deployed_capital_usd
        description: "Current deployed capital from instrument positions for this fund and industry, converted to USD"
        tests:
          - not_null
      
      - name: closed_pipeline_usd
        description: "Cumulative sum of opportunities (for this fund and stage) that have closed up to and including this month, converted to USD"
        tests:
          - not_null
      
      - name: total_exposure_usd
        description: "Sum of deployed capital and cumulative closed pipeline (shows total exposure growing over time)"
        tests:
          - not_null
      
      - name: period_type
        description: "Indicates if the month is 'Current', 'Historical', or 'Forecast'"
        tests:
          - not_null
          - accepted_values:
              values: ['Current', 'Historical', 'Forecast']
      
      - name: as_of_date
        description: "Date of the latest snapshot used for deployed capital calculations"

  - name: metrics_fund_performance_latest
    description: |
      BI-ready metrics model providing a single-row-per-fund snapshot of key performance indicators.
      Combines data from fund administration (commitments, capital calls, distributions) with 
      portfolio system (current NAV) to calculate standard private markets performance metrics.
      
      **Grain**: One row per fund (latest snapshot date)
      
      **Source Systems**: Fund Administration (ADMIN), Portfolio Management (PM)
      
      **Use Cases**:
      - Fund performance scorecards
      - DPI and TVPI comparison charts
      - Fund vintage analysis
      - Commitment vs deployment tracking
      
      **Example Query**:
      ```sql
      SELECT 
        fund_name,
        vintage,
        total_committed_capital,
        total_called_capital,
        current_nav,
        dpi,
        tvpi
      FROM metrics_fund_performance_latest
      ORDER BY tvpi DESC;
      ```
    columns:
      - name: fund_id
        description: "Unique fund identifier - Primary Key"
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('dim_funds')
              field: fund_id
      
      - name: fund_name
        description: "Fund name from canonical dimension"
        tests:
          - not_null
      
      - name: fund_type
        description: "Fund type (e.g., Private Equity, Venture Capital, Credit)"
      
      - name: vintage
        description: "Vintage year of the fund"
      
      - name: base_currency_code
        description: "Base currency code for the fund"
        tests:
          - not_null
      
      - name: as_of_date
        description: "Date of the latest snapshot"
        tests:
          - not_null
      
      - name: total_committed_capital
        description: "Total committed capital from investor commitments"
        tests:
          - not_null
      
      - name: total_called_capital
        description: "Total called capital from capital call transactions"
        tests:
          - not_null
      
      - name: total_distributed_capital
        description: "Total distributed capital from distribution transactions"
        tests:
          - not_null
      
      - name: current_nav
        description: "Current Net Asset Value from latest instrument valuations"
        tests:
          - not_null
      
      - name: dpi
        description: "Distributions to Paid-In capital ratio (total_distributed_capital / total_called_capital)"
      
      - name: tvpi
        description: "Total Value to Paid-In capital ratio ((current_nav + total_distributed_capital) / total_called_capital)"
      
      - name: unrealized_value
        description: "Unrealized value (current NAV)"
      
      - name: realized_value
        description: "Realized value (total distributions)"
      
      - name: remaining_commitment
        description: "Remaining commitment (total_committed_capital - total_called_capital)"
      
      - name: source_systems
        description: "Comma-separated list of contributing source systems (e.g., 'ADMIN, PM')"
        tests:
          - not_null

  - name: metrics_pipeline_by_stage
    description: |
      BI-ready metrics model aggregating CRM opportunities by deal stage to show pipeline health 
      and forecast future deployment. Enables funnel analysis and deal velocity tracking.
      
      **Grain**: One row per fund per stage
      
      **Source Systems**: CRM
      
      **Use Cases**:
      - Pipeline funnel charts
      - Deal stage progression analysis
      - Average deal size by stage
      - Deal aging and velocity metrics
      
      **Example Query**:
      ```sql
      SELECT 
        fund_name,
        stage_name,
        deal_count,
        total_amount_usd,
        avg_deal_size_usd,
        oldest_deal_days
      FROM metrics_pipeline_by_stage
      ORDER BY fund_name, stage_order;
      ```
    columns:
      - name: fund_id
        description: "Fund identifier - Foreign Key to dim_funds"
        tests:
          - not_null
          - relationships:
              to: ref('dim_funds')
              field: fund_id
      
      - name: fund_name
        description: "Fund name from canonical dimension"
        tests:
          - not_null
      
      - name: stage_id
        description: "Stage identifier - Foreign Key to dim_stages"
        tests:
          - not_null
          - relationships:
              to: ref('dim_stages')
              field: stage_id
      
      - name: stage_name
        description: "Stage name from canonical dimension"
        tests:
          - not_null
      
      - name: stage_order
        description: "Numeric ordering for proper stage sequencing in visualizations"
        tests:
          - not_null
      
      - name: deal_count
        description: "Count of active opportunities in this stage"
        tests:
          - not_null
      
      - name: total_amount_usd
        description: "Sum of opportunity amounts in USD"
        tests:
          - not_null
      
      - name: avg_deal_size_usd
        description: "Average opportunity amount in USD"
      
      - name: oldest_deal_days
        description: "Days since the oldest opportunity in this stage was created"
      
      - name: newest_deal_days
        description: "Days since the newest opportunity in this stage was created"
      
      - name: source_system
        description: "Source system indicator (CRM)"
        tests:
          - not_null
          - accepted_values:
              values: ['CRM']
      
      - name: as_of_date
        description: "Current date when metrics were calculated"
        tests:
          - not_null

  - name: metrics_company_financials_trend
    description: |
      BI-ready metrics model providing time-series financial metrics for portfolio companies.
      Enables tracking of operating performance, growth rates, and margin trends over time.
      
      **Grain**: One row per company per period (quarterly)
      
      **Source Systems**: Portfolio Management (PM)
      
      **Use Cases**:
      - Revenue and EBITDA trend line charts
      - Growth rate analysis
      - Margin trend tracking
      - Company performance comparison
      
      **Example Query**:
      ```sql
      SELECT 
        company_name,
        period_year,
        period_quarter,
        revenue_usd,
        ebitda_usd,
        ebitda_margin_pct,
        revenue_growth_pct
      FROM metrics_company_financials_trend
      WHERE company_id = 'COMP123'
      ORDER BY period_end_date;
      ```
    columns:
      - name: company_id
        description: "Company identifier - Foreign Key to dim_companies"
        tests:
          - not_null
          - relationships:
              to: ref('dim_companies')
              field: company_id
      
      - name: company_name
        description: "Company name from canonical dimension"
        tests:
          - not_null
      
      - name: fund_id
        description: "Primary fund investor - Foreign Key to dim_funds"
        tests:
          - relationships:
              to: ref('dim_funds')
              field: fund_id
      
      - name: fund_name
        description: "Primary fund name for context"
      
      - name: period_end_date
        description: "End date of the financial reporting period"
        tests:
          - not_null
      
      - name: period_year
        description: "Year extracted from period_end_date"
        tests:
          - not_null
      
      - name: period_quarter
        description: "Quarter extracted from period_end_date (1-4)"
        tests:
          - not_null
      
      - name: revenue_usd
        description: "Revenue for the period, converted to USD"
      
      - name: ebitda_usd
        description: "EBITDA for the period, converted to USD"
      
      - name: net_income_usd
        description: "Net income for the period, converted to USD"
      
      - name: ebitda_margin_pct
        description: "EBITDA margin as percentage (EBITDA / revenue * 100)"
      
      - name: revenue_growth_pct
        description: "Period-over-period revenue growth percentage"
      
      - name: ebitda_growth_pct
        description: "Period-over-period EBITDA growth percentage"
      
      - name: current_valuation_usd
        description: "Latest company valuation in USD for context"
      
      - name: source_system
        description: "Source system indicator (PM)"
        tests:
          - not_null
          - accepted_values:
              values: ['PM']

  - name: metrics_investment_activity_monthly
    description: |
      BI-ready metrics model showing monthly transaction activity by type to understand cash flow 
      patterns and deployment pace. Aggregates all transaction types from accounting and fund admin.
      
      **Grain**: One row per fund per month per transaction type
      
      **Source Systems**: Accounting (ACC), Fund Administration (ADMIN)
      
      **Use Cases**:
      - Investment activity timeline charts
      - Cash flow pattern analysis
      - Deployment pace tracking
      - Transaction type breakdown
      
      **Example Query**:
      ```sql
      SELECT 
        activity_year,
        activity_month,
        transaction_type,
        SUM(total_amount_usd) as total_amount
      FROM metrics_investment_activity_monthly
      WHERE fund_id = 'FUND123'
      GROUP BY activity_year, activity_month, transaction_type
      ORDER BY activity_month;
      ```
    columns:
      - name: fund_id
        description: "Fund identifier - Foreign Key to dim_funds"
        tests:
          - not_null
          - relationships:
              to: ref('dim_funds')
              field: fund_id
      
      - name: fund_name
        description: "Fund name from canonical dimension"
        tests:
          - not_null
      
      - name: activity_month
        description: "First day of the month for the transaction activity"
        tests:
          - not_null
      
      - name: activity_year
        description: "Year extracted from activity_month"
        tests:
          - not_null
      
      - name: activity_quarter
        description: "Quarter extracted from activity_month (1-4)"
        tests:
          - not_null
      
      - name: transaction_type
        description: "Type of transaction (DRAWDOWN, DISTRIBUTION, INVESTMENT_TRANSACTION, EXPENSE, MANAGEMENT_FEE)"
        tests:
          - not_null
          - accepted_values:
              values: ['DRAWDOWN', 'DISTRIBUTION', 'INVESTMENT_TRANSACTION', 'EXPENSE', 'MANAGEMENT_FEE']
      
      - name: transaction_count
        description: "Count of transactions in this month and type"
        tests:
          - not_null
      
      - name: total_amount_usd
        description: "Sum of transaction amounts in USD"
        tests:
          - not_null
      
      - name: source_systems
        description: "Source system indicator (varies by transaction type)"
        tests:
          - not_null

  - name: metrics_loan_portfolio_summary
    description: |
      BI-ready metrics model aggregating loan portfolio metrics for debt-focused funds. Provides
      weighted average rates, maturity profile, and utilization metrics.
      
      **Grain**: One row per fund per maturity year
      
      **Source Systems**: Portfolio Management (PM)
      
      **Use Cases**:
      - Loan maturity profile charts
      - Weighted average yield analysis
      - Portfolio utilization tracking
      - Credit exposure monitoring
      
      **Example Query**:
      ```sql
      SELECT 
        fund_name,
        maturity_year,
        loan_count,
        total_commitment_usd,
        total_outstanding_usd,
        weighted_avg_rate_pct,
        utilization_pct
      FROM metrics_loan_portfolio_summary
      ORDER BY fund_name, maturity_year;
      ```
    columns:
      - name: fund_id
        description: "Fund identifier - Foreign Key to dim_funds"
        tests:
          - not_null
          - relationships:
              to: ref('dim_funds')
              field: fund_id
      
      - name: fund_name
        description: "Fund name from canonical dimension"
        tests:
          - not_null
      
      - name: maturity_year
        description: "Year when loans mature, extracted from maturity_date"
        tests:
          - not_null
      
      - name: loan_count
        description: "Count of loans maturing in this year"
        tests:
          - not_null
      
      - name: total_commitment_usd
        description: "Sum of loan commitment amounts in USD"
        tests:
          - not_null
      
      - name: total_outstanding_usd
        description: "Sum of current outstanding principal in USD"
        tests:
          - not_null
      
      - name: weighted_avg_rate_pct
        description: "Weighted average interest rate (weighted by outstanding principal)"
      
      - name: weighted_avg_spread_bps
        description: "Weighted average spread in basis points (weighted by outstanding principal)"
      
      - name: utilization_pct
        description: "Utilization percentage (total_outstanding_usd / total_commitment_usd * 100)"
      
      - name: source_system
        description: "Source system indicator (PM)"
        tests:
          - not_null
          - accepted_values:
              values: ['PM']
      
      - name: as_of_date
        description: "Date of the latest loan snapshot"
        tests:
          - not_null

  - name: metrics_position_performance
    description: |
      Position-level investment performance metrics providing comprehensive returns analysis 
      including MOIC, IRR, and cashflow metrics for each investment position. Combines valuation 
      snapshots with cashflow history to calculate realized and unrealized returns.
      
      **Grain**: One row per instrument per period_end_date (latest snapshot)
      
      **Source Systems**: Portfolio Management (PM)
      
      **Use Cases**:
      - Investment-level returns analysis and reporting
      - MOIC and IRR calculations for individual positions
      - Portfolio performance attribution
      - Realized vs unrealized value tracking
      - Ownership percentage tracking over time
      
      **Example Query**:
      ```sql
      -- Top performing investments by MOIC
      SELECT 
        fund_name,
        company_name,
        instrument_type,
        cumulative_invested,
        total_value,
        gross_moic,
        gross_irr,
        holding_period_years
      FROM metrics_position_performance
      WHERE gross_moic IS NOT NULL
      ORDER BY gross_moic DESC
      LIMIT 10;
      
      -- Portfolio summary by fund
      SELECT 
        fund_name,
        COUNT(*) as position_count,
        SUM(cumulative_invested) as total_invested,
        SUM(realized_proceeds) as total_realized,
        SUM(current_fair_value) as total_unrealized,
        SUM(total_value) as total_value,
        SUM(total_value) / NULLIF(SUM(cumulative_invested), 0) as portfolio_moic
      FROM metrics_position_performance
      GROUP BY fund_name;
      ```
    columns:
      - name: instrument_id
        description: "Instrument identifier - Foreign Key to dim_instruments (part of unique key)"
        tests:
          - not_null
          - relationships:
              to: ref('dim_instruments')
              field: instrument_id
      
      - name: instrument_name
        description: "Instrument name from canonical dimension"
        tests:
          - not_null
      
      - name: period_end_date
        description: "End date of the latest valuation snapshot (part of unique key)"
        tests:
          - not_null
      
      - name: fund_id
        description: "Fund identifier - Foreign Key to dim_funds"
        tests:
          - not_null
          - relationships:
              to: ref('dim_funds')
              field: fund_id
      
      - name: fund_name
        description: "Fund name from canonical dimension"
        tests:
          - not_null
      
      - name: company_id
        description: "Company identifier - Foreign Key to dim_companies"
        tests:
          - relationships:
              to: ref('dim_companies')
              field: company_id
      
      - name: company_name
        description: "Company name from canonical dimension"
      
      - name: instrument_type
        description: "Type of instrument (EQUITY, CREDIT, etc.)"
        tests:
          - not_null
      
      - name: initial_investment_date
        description: "Date of initial investment (inception_date from dim_instruments)"
        tests:
          - not_null
      
      - name: exit_date
        description: "Date of exit/termination if applicable (termination_date from dim_instruments)"
      
      - name: initial_cost
        description: "Initial cost basis of the investment, converted to fund base currency"
      
      - name: cumulative_invested
        description: "Total capital invested through contributions, purchases, and draws (always positive)"
        tests:
          - not_null
      
      - name: realized_proceeds
        description: "Total proceeds received through sales, distributions, dividends, principal, and prepayments (always positive)"
        tests:
          - not_null
      
      - name: current_fair_value
        description: "Current fair market value from latest instrument snapshot"
        tests:
          - not_null
      
      - name: total_value
        description: "Total value = realized_proceeds + current_fair_value (TVPI numerator)"
        tests:
          - not_null
      
      - name: gross_moic
        description: "Gross Multiple on Invested Capital = total_value / cumulative_invested (TVPI)"
      
      - name: gross_irr
        description: "Gross Internal Rate of Return approximation using POWER function: (MOIC^(1/holding_period_years)) - 1"
      
      - name: ownership_pct_initial
        description: "Initial ownership percentage from dim_instruments_equity"
      
      - name: ownership_pct_current
        description: "Current ownership percentage from latest equity snapshot"
      
      - name: holding_period_years
        description: "Holding period in years from inception_date to exit_date (or current date if not exited)"
        tests:
          - not_null

  - name: metrics_returns_cashflows
    description: |
      Standardized cashflow-level view for IRR and returns analysis. Provides a complete 
      transaction history with direction classification and signed amounts for time-weighted 
      return calculations.
      
      **Grain**: One row per cashflow transaction (fund_id, instrument_id, cashflow_date, cashflow_type)
      
      **Source Systems**: Portfolio Management (PM), Fund Administration (ADMIN)
      
      **Use Cases**:
      - IRR calculations using XIRR methodology
      - Cashflow timeline visualizations
      - Investment vs distribution analysis
      - Fund-level cashflow aggregation
      - Position-level returns analysis
      
      **Example Query**:
      ```sql
      -- Cashflow summary by fund and direction
      SELECT 
        fund_name,
        direction,
        COUNT(*) as transaction_count,
        SUM(cashflow_amount) as total_amount
      FROM metrics_returns_cashflows
      WHERE cashflow_date >= '2023-01-01'
      GROUP BY fund_name, direction
      ORDER BY fund_name, direction;
      
      -- IRR calculation input for a specific instrument
      SELECT 
        cashflow_date,
        signed_amount
      FROM metrics_returns_cashflows
      WHERE instrument_id = 'INST123'
      ORDER BY cashflow_date;
      ```
    columns:
      - name: fund_id
        description: "Fund identifier - Foreign Key to dim_funds"
        tests:
          - not_null
          - relationships:
              to: ref('dim_funds')
              field: fund_id
      
      - name: fund_name
        description: "Fund name from canonical dimension"
        tests:
          - not_null
      
      - name: instrument_id
        description: "Instrument identifier - Foreign Key to dim_instruments"
        tests:
          - not_null
          - relationships:
              to: ref('dim_instruments')
              field: instrument_id
      
      - name: instrument_name
        description: "Instrument name from canonical dimension"
        tests:
          - not_null
      
      - name: company_id
        description: "Company identifier - Foreign Key to dim_companies"
        tests:
          - relationships:
              to: ref('dim_companies')
              field: company_id
      
      - name: company_name
        description: "Company name from canonical dimension"
      
      - name: cashflow_date
        description: "Date of the cashflow transaction"
        tests:
          - not_null
      
      - name: cashflow_type
        description: "Type of cashflow - CONTRIBUTION, PURCHASE, DRAW (outflows) or DISTRIBUTION, DIVIDEND, INTEREST, FEE, PRINCIPAL, PREPAYMENT, SALE, OTHER (inflows)"
        tests:
          - not_null
          - accepted_values:
              values: ['CONTRIBUTION', 'DISTRIBUTION', 'DIVIDEND', 'INTEREST', 'FEE', 'PRINCIPAL', 'DRAW', 'PREPAYMENT', 'OTHER', 'PURCHASE', 'SALE']
      
      - name: cashflow_amount
        description: "Cashflow amount in fund base currency (always positive, use direction or signed_amount for IRR calculations)"
        tests:
          - not_null
      
      - name: currency_code
        description: "Original currency code of the cashflow - Foreign Key to dim_currencies"
        tests:
          - not_null
          - relationships:
              to: ref('dim_currencies')
              field: currency_code
      
      - name: fx_rate
        description: "Foreign exchange rate used for conversion to fund base currency"
      
      - name: direction
        description: "Cashflow direction - 'outflow' for investments (CONTRIBUTION, PURCHASE, DRAW) or 'inflow' for returns (all other types)"
        tests:
          - not_null
          - accepted_values:
              values: ['outflow', 'inflow']
      
      - name: signed_amount
        description: "Signed cashflow amount for IRR calculations - negative for outflows, positive for inflows"
        tests:
          - not_null

  - name: metrics_fund_performance
    description: |
      Fund-level performance metrics providing comprehensive fund performance indicators including 
      NAV, commitment metrics, return multiples, portfolio composition, and credit exposure. 
      Combines fund snapshots with aggregated instrument valuations to deliver a complete view 
      of fund performance over time.
      
      **Grain**: One row per fund per period_end_date
      
      **Source Systems**: Fund Administration (ADMIN), Portfolio Management (PM)
      
      **Use Cases**:
      - Fund performance dashboards and scorecards
      - TVPI, DPI, and RVPI tracking over time
      - Commitment and deployment analysis
      - Portfolio composition monitoring (company and position counts)
      - Credit exposure and utilization tracking
      - Fund-level NAV reconciliation
      
      **Example Query**:
      ```sql
      -- Latest fund performance metrics
      SELECT 
        fund_name,
        period_end_date,
        fund_nav,
        total_commitments,
        unfunded_commitment,
        tvpi,
        dpi,
        rvpi,
        number_of_portfolio_companies,
        number_of_positions
      FROM metrics_fund_performance
      WHERE period_end_date = (SELECT MAX(period_end_date) FROM metrics_fund_performance)
      ORDER BY fund_name;
      
      -- Fund performance trend over time
      SELECT 
        period_end_date,
        fund_name,
        fund_nav,
        tvpi,
        dpi
      FROM metrics_fund_performance
      WHERE fund_id = 'FUND123'
      ORDER BY period_end_date;
      ```
    columns:
      - name: fund_id
        description: "Fund identifier - Foreign Key to dim_funds (part of unique key)"
        tests:
          - not_null
          - relationships:
              to: ref('dim_funds')
              field: fund_id
      
      - name: fund_name
        description: "Fund name from canonical dimension"
        tests:
          - not_null
      
      - name: period_end_date
        description: "End date of the reporting period (part of unique key)"
        tests:
          - not_null
      
      - name: fund_nav
        description: "Fund Net Asset Value = sum of instrument fair values + fund cash amount"
        tests:
          - not_null
      
      - name: total_commitments
        description: "Total committed capital from investor commitments"
        tests:
          - not_null
      
      - name: total_called_capital
        description: "Total called capital from capital call transactions"
        tests:
          - not_null
      
      - name: unfunded_commitment
        description: "Unfunded commitment = total_commitments - total_called_capital"
      
      - name: total_distributions
        description: "Total distributions to investors"
      
      - name: dpi
        description: "Distributions to Paid-In capital ratio (DPI)"
      
      - name: rvpi
        description: "Residual Value to Paid-In capital ratio (RVPI)"
      
      - name: tvpi
        description: "Total Value to Paid-In capital ratio = DPI + RVPI"
      
      - name: expected_coc
        description: "Expected cash-on-cash return"
      
      - name: number_of_portfolio_companies
        description: "Count of distinct portfolio companies with active instruments"
        tests:
          - not_null
      
      - name: number_of_positions
        description: "Count of distinct active instruments"
        tests:
          - not_null
      
      - name: lines_of_credit_outstanding
        description: "Total principal outstanding from credit instrument snapshots"
        tests:
          - not_null
      
      - name: peak_outstanding_credit
        description: "Peak outstanding credit calculated using window function with UNBOUNDED PRECEDING"
      
      - name: interest_income
        description: "Total interest income from fund snapshots"
      
      - name: as_of_date
        description: "Date when metrics were calculated"
        tests:
          - not_null

  - name: metrics_company_performance
    description: |
      Company-level financial performance metrics providing comprehensive financial metrics 
      including revenue, profitability, balance sheet items, and valuation multiples. Combines 
      company financials with valuations and geographic/industry classifications to deliver a 
      complete view of portfolio company performance over time.
      
      **Grain**: One row per company per period_end_date
      
      **Source Systems**: Portfolio Management (PM)
      
      **Use Cases**:
      - Portfolio company financial performance tracking
      - Revenue and EBITDA trend analysis
      - Valuation multiple monitoring (EV/EBITDA, EV/Revenue)
      - Balance sheet health assessment
      - Geographic and industry exposure analysis
      - Company-level benchmarking and comparison
      
      **Example Query**:
      ```sql
      -- Latest company performance metrics
      SELECT 
        company_name,
        period_end_date,
        revenue,
        ebitda,
        ebitda_margin,
        enterprise_value,
        ev_to_ebitda,
        primary_country,
        primary_industry
      FROM metrics_company_performance
      WHERE period_end_date = (SELECT MAX(period_end_date) FROM metrics_company_performance)
      ORDER BY revenue DESC;
      
      -- Company performance trend over time
      SELECT 
        period_end_date,
        company_name,
        revenue,
        ebitda,
        ebitda_margin
      FROM metrics_company_performance
      WHERE company_id = 'COMP123'
      ORDER BY period_end_date;
      ```
    columns:
      - name: company_id
        description: "Company identifier - Foreign Key to dim_companies (part of unique key)"
        tests:
          - not_null
          - relationships:
              to: ref('dim_companies')
              field: company_id
      
      - name: company_name
        description: "Company name from canonical dimension"
        tests:
          - not_null
      
      - name: period_end_date
        description: "End date of the financial reporting period (part of unique key)"
        tests:
          - not_null
      
      - name: revenue
        description: "Total revenue for the period from company financials"
      
      - name: ebitda
        description: "Earnings before interest, taxes, depreciation, and amortization from company financials"
      
      - name: ebitda_margin
        description: "EBITDA margin as percentage = (ebitda / revenue) * 100 with NULLIF protection"
      
      - name: cash
        description: "Cash and cash equivalents from company financials"
      
      - name: total_assets
        description: "Total assets from company financials"
      
      - name: total_liabilities
        description: "Total liabilities from company financials"
      
      - name: equity
        description: "Total equity from company financials"
      
      - name: net_debt
        description: "Net debt = total_liabilities - cash"
      
      - name: enterprise_value
        description: "Enterprise value from latest actual valuation for the period"
      
      - name: ev_to_ebitda
        description: "Enterprise value to EBITDA multiple = enterprise_value / ebitda with NULLIF protection"
      
      - name: ev_to_revenue
        description: "Enterprise value to revenue multiple = enterprise_value / revenue with NULLIF protection"
      
      - name: primary_country
        description: "Primary country from br_company_countries where primary_flag is TRUE with temporal validity check"
      
      - name: primary_industry
        description: "Primary industry from br_company_industries where primary_flag is TRUE with temporal validity check"
      
      - name: reporting_currency
        description: "Currency code for the financial data from company financials"
