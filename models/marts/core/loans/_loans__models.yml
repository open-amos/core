version: 2

models:
  - name: dim_loans
    description: "Canonical loan dimension - individual loan instruments within facilities"
    columns:
      - name: loan_id
        description: "Unique loan identifier - Primary Key"
        tests:
          - unique
          - not_null
      
      - name: instrument_id
        description: "Associated instrument - Foreign Key to dim_instruments (unique)"
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('dim_instruments')
              field: instrument_id
      
      - name: facility_id
        description: "Parent facility - Foreign Key to dim_facilities"
        tests:
          - not_null
          - relationships:
              to: ref('dim_facilities')
              field: facility_id
      
      - name: loan_type
        description: "Type of loan - Enum: TERM, REVOLVER, DDTL, BRIDGE, MEZZ"
        tests:
          - not_null
          - accepted_values:
              values: ['TERM', 'REVOLVER', 'DDTL', 'BRIDGE', 'MEZZ']
      
      - name: tranche_label
        description: "Tranche label for the loan"
      
      - name: commitment_amount
        description: "Commitment amount for the loan"
      
      - name: currency_code
        description: "Currency code for the loan - Foreign Key to dim_currencies"
        tests:
          - not_null
          - relationships:
              to: ref('dim_currencies')
              field: currency_code
      
      - name: start_date
        description: "Start date of the loan"
        tests:
          - not_null
      
      - name: maturity_date
        description: "Maturity date of the loan"
        tests:
          - not_null
      
      - name: interest_index
        description: "Interest rate index - Enum: SOFR, EURIBOR, SONIA, FED_FUNDS, FIXED"
        tests:
          - not_null
          - accepted_values:
              values: ['SOFR', 'EURIBOR', 'SONIA', 'FED_FUNDS', 'FIXED']
      
      - name: index_tenor_days
        description: "Tenor in days for the interest index"
      
      - name: fixed_rate_pct
        description: "Fixed interest rate percentage"
      
      - name: spread_bps
        description: "Spread in basis points over the index"
        tests:
          - not_null
      
      - name: floor_pct
        description: "Interest rate floor percentage"
      
      - name: day_count
        description: "Day count convention - Enum: 30E_360, ACT_360, ACT_365, ACT_ACT"
        tests:
          - not_null
          - accepted_values:
              values: ['30E_360', 'ACT_360', 'ACT_365', 'ACT_ACT']
      
      - name: pay_freq_months
        description: "Payment frequency in months"
        tests:
          - not_null
      
      - name: amortization_type
        description: "Amortization type - Enum: BULLET, STRAIGHT_LINE, CUSTOM_SCHEDULE"
        tests:
          - not_null
          - accepted_values:
              values: ['BULLET', 'STRAIGHT_LINE', 'CUSTOM_SCHEDULE']
      
      - name: security_rank
        description: "Security rank - Enum: SENIOR_SECURED, SENIOR_UNSECURED, SECOND_LIEN, MEZZANINE, PIK"
        tests:
          - accepted_values:
              values: ['SENIOR_SECURED', 'SENIOR_UNSECURED', 'SECOND_LIEN', 'MEZZANINE', 'PIK']
      
      - name: status
        description: "Current status of the loan"
      
      - name: created_at
        description: "Timestamp when the loan record was created"
      
      - name: updated_at
        description: "Timestamp when the loan record was last updated"

  - name: fct_loan_snapshots
    description: "Fact table for loan position snapshots over time"
    columns:
      - name: loan_snapshot_id
        description: "Unique loan snapshot identifier - Primary Key"
        tests:
          - unique
          - not_null
      
      - name: loan_id
        description: "Loan identifier - Foreign Key to dim_loans"
        tests:
          - not_null
          - relationships:
              to: ref('dim_loans')
              field: loan_id
      
      - name: period_start_date
        description: "Start date of the reporting period"
      
      - name: period_end_date
        description: "End date of the reporting period"
        tests:
          - not_null
      
      - name: frequency
        description: "Reporting frequency (e.g., QUARTERLY, ANNUAL)"
      
      - name: reporting_basis
        description: "Reporting basis (e.g., GAAP, IFRS)"
        tests:
          - not_null
      
      - name: snapshot_source
        description: "Source of the snapshot data"
        tests:
          - not_null
          - accepted_values:
              values: ['ADMIN', 'INTERNAL']
      
      - name: principal_outstanding
        description: "Outstanding principal amount"
      
      - name: undrawn_commitment
        description: "Undrawn commitment amount"
      
      - name: accrued_interest
        description: "Accrued interest amount"
      
      - name: accrued_fees
        description: "Accrued fees amount"
      
      - name: amortized_cost
        description: "Amortized cost of the loan"
      
      - name: fair_value
        description: "Fair value of the loan"
      
      - name: expected_loss
        description: "Expected loss amount"
      
      - name: status
        description: "Current status of the loan"
      
      - name: currency_code
        description: "Currency code for the loan - Foreign Key to dim_currencies"
        tests:
          - relationships:
              to: ref('dim_currencies')
              field: currency_code
      
      - name: fx_rate
        description: "Foreign exchange rate used for conversion"
      
      - name: principal_outstanding_converted
        description: "Principal outstanding converted to fund base currency"
      
      - name: undrawn_commitment_converted
        description: "Undrawn commitment converted to fund base currency"
      
      - name: accrued_interest_converted
        description: "Accrued interest converted to fund base currency"
      
      - name: accrued_fees_converted
        description: "Accrued fees converted to fund base currency"
      
      - name: amortized_cost_converted
        description: "Amortized cost converted to fund base currency"
      
      - name: fair_value_converted
        description: "Fair value converted to fund base currency"
      
      - name: source_file_ref
        description: "Reference to source file or system"
      
      - name: created_at
        description: "Timestamp when the snapshot record was created"
      
      - name: updated_at
        description: "Timestamp when the snapshot record was last updated"
