version: 2

models:
  - name: dim_facilities
    description: "Canonical facility dimension - loan facilities for debt financing"
    columns:
      - name: facility_id
        description: "Unique facility identifier - Primary Key"
        tests:
          - unique
          - not_null
      
      - name: fund_id
        description: "Fund providing the facility - Foreign Key to dim_funds"
        tests:
          - not_null
          - relationships:
              to: ref('dim_funds')
              field: fund_id
      
      - name: borrower_company_id
        description: "Company borrowing from the facility - Foreign Key to dim_companies"
        tests:
          - not_null
          - relationships:
              to: ref('dim_companies')
              field: company_id
      
      - name: facility_type
        description: "Type of facility - Enum: TERM_LOAN_B, UNITRANCHE, REVOLVER, DELAYED_DRAWDOWN, MEZZANINE, RCF, BRIDGE"
        tests:
          - not_null
          - accepted_values:
              values: ['TERM_LOAN_B', 'UNITRANCHE', 'REVOLVER', 'DELAYED_DRAWDOWN', 'MEZZANINE', 'RCF', 'BRIDGE']
      
      - name: agent_counterparty_id
        description: "Agent counterparty for the facility - Foreign Key to dim_counterparties"
        tests:
          - relationships:
              to: ref('dim_counterparties')
              field: counterparty_id
      
      - name: agreement_date
        description: "Date when the facility agreement was signed"
        tests:
          - not_null
      
      - name: effective_date
        description: "Date when the facility became effective"
      
      - name: maturity_date
        description: "Date when the facility matures"
      
      - name: currency_code
        description: "Currency code for the facility - Foreign Key to dim_currencies"
        tests:
          - not_null
          - relationships:
              to: ref('dim_currencies')
              field: currency_code
      
      - name: total_commitment
        description: "Total commitment amount for the facility"
      
      - name: purpose
        description: "Purpose of the facility"
      
      - name: created_at
        description: "Timestamp when the facility record was created"
      
      - name: updated_at
        description: "Timestamp when the facility record was last updated"

  - name: br_facility_lenders
    description: "Bridge table for facility syndicate participants - links facilities to lenders (counterparties or funds)"
    columns:
      - name: facility_id
        description: "Facility identifier - Foreign Key to dim_facilities"
        tests:
          - not_null
          - relationships:
              to: ref('dim_facilities')
              field: facility_id
      
      - name: counterparty_id
        description: "Counterparty lender identifier - Foreign Key to dim_counterparties (XOR with fund_id)"
        tests:
          - relationships:
              to: ref('dim_counterparties')
              field: counterparty_id
      
      - name: fund_id
        description: "Fund lender identifier - Foreign Key to dim_funds (XOR with counterparty_id)"
        tests:
          - relationships:
              to: ref('dim_funds')
              field: fund_id
      
      - name: syndicate_role
        description: "Role in the syndicate - Enum: AGENT, ARRANGER, LENDER, CO_LENDER, ADMIN_AGENT"
        tests:
          - accepted_values:
              values: ['AGENT', 'ARRANGER', 'LENDER', 'CO_LENDER', 'ADMIN_AGENT']
      
      - name: commitment_amount
        description: "Commitment amount from this lender"
      
      - name: allocation_pct
        description: "Percentage allocation of the facility"
      
      - name: primary_flag
        description: "Indicates if this is the primary lender"
      
      - name: created_at
        description: "Timestamp when the relationship was created"
      
      - name: updated_at
        description: "Timestamp when the relationship was last updated"
